<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 7</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.1.1/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 300 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var player;
    var platforms;
    var cielo;
    var cursors;
    var game = new Phaser.Game(config);
    var plat;

    function preload ()
    {
        this.load.image('sky', 'assets/sky.png');
        this.load.image('ground', 'assets/platform.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('base', 'assets/base.png');
        this.load.image('bomb', 'assets/bomb.png');
        this.load.image('cielopro', 'assets/1.jpg');
        this.load.image('bicho', 'assets/bicho.png');
        this.load.spritesheet('waluigi', 'assets/waluigi.png', { frameWidth: 38, frameHeight: 50 });
    }

    class jefe{
        constructor(juego, player){
            this.player = player;
            this.juego = juego;
            this.sprite = juego.physics.add.sprite(680, Math.floor(Math.random() * 270) + 180 , 'bicho');
            this.vida = 3;
            juego.physics.add.collider(this.sprite, player);
            this.sprite.setCollideWorldBounds(false);
            this.sprite.body.allowGravity=false;
            this.TirarBola();
            this.muerto = false;
        }
        
        TirarBola(){
            if(this.muerto)
                return;
            var bola = new bolaDeFuego(620, this.sprite.y - 40, this.juego, this.vida,-(450 + (3-this.vida)*150), this.player)
        }

        morir(){
            this.vida--;
            if(vida<=0){
                this.muerto = true;
                this.sprite.destroy();
            }
        }
    }

    class bolaDeFuego{
        constructor(x, y, juego, tipo, velocidad, player){
            this.juego = juego;
            var bola;
            if(tipo == 3){
                bola = juego.physics.add.sprite(x, y, 'bomb')
                bola.scaleX = 2;
                bola.scaleY = 2;
                bola.setTint(0x00ff00);
                juego.physics.add.collider(bola, player.sprite, function(){ bola.destroy(); player.morir(); }, null, this);
            }
            if(tipo == 2){
                bola = juego.physics.add.sprite(x, y, 'bomb')
                bola.scaleX = 3;
                bola.scaleY = 3;
                bola.setTint(0xffff00);
                juego.physics.add.collider(bola, player.sprite, function(){ bola.destroy(); player.morir(); }, null, this);
            }
            if(tipo == 1){
                bola = juego.physics.add.sprite(x, y, 'bomb')
                bola.scaleX = 4;
                bola.scaleY = 4;
                bola.setTint(0xff0000);
                juego.physics.add.collider(bola, player.sprite, function(){ bola.destroy(); player.morir(); }, null, this);
            }
            if(tipo == 0){
                bola = juego.physics.add.sprite(x, y, 'bomb')
                bola.scaleX = 1;
                bola.scaleY = 1;
                bola.setTint(0xcc00ff);
                juego.physics.add.collider(bola, player.sprite, function(){ bola.destroy(); player.morir(); }, null, this);
            }
            bola.body.allowGravity = false;
            bola.setVelocityX(velocidad);
        }
    }

    class jugador{
		constructor(sprite){
            this.muerto = false;
            this.corriendo = false;
            this.sprite = sprite
			this.saltando = false;
            this.mirandoDerecha = true;
            this.arriba = false;
            this.agachado = false;
		}
        morir(){
            this.muerto = true;
            this.sprite.destroy();
        }
		mover(direccion){
            if(this.muerto){
                return;
            }
			if(direccion == "Izquierda"){
                this.mirandoDerecha = false;
                if(this.corriendo){
            	    this.sprite.setVelocityX(-300);
	                this.sprite.anims.play('runL', true);
                }else{
            	    this.sprite.setVelocityX(-160);
	                this.sprite.anims.play('left', true);
                }
			}else if(direccion == "Derecha"){
                this.mirandoDerecha = true;
                if(this.corriendo){
                    this.sprite.setVelocityX(300);
                    this.sprite.anims.play('run',true);
                }else{
				    this.sprite.setVelocityX(160);
				    this.sprite.anims.play('right',true);
                }
            }else if(direccion == "Arriba"){
                this.arriba = true;
            }else if(direccion == "Abajo"){
                this.abajo = true;
			}else if(direccion == "No"){
                this.sprite.setVelocityX(0);
                if(this.arriba && !this.abajo){
                        if(this.mirandoDerecha)
                            this.sprite.anims.play('up');
                        else
                            this.sprite.anims.play('upL');
                }else if(this.abajo && !this.arriba){
                        if(this.mirandoDerecha)
                            this.sprite.anims.play('down');
                        else
                            this.sprite.anims.play('downL');
                }else{
                    if(this.mirandoDerecha)
                        this.sprite.anims.play('turn');
                    else
                        this.sprite.anims.play('turnL')
                }
                    
            }
		}
        saltar(){
            if(this.muerto)
                return;
            this.saltando = true;
            this.sprite.setVelocityY(-330);
        }
        caer(){
            if(this.muerto)
                return;
            if(this.saltando){
                if(this.mirandoDerecha)
                    this.sprite.anims.play('jump');
                else
                    this.sprite.anims.play('jumpL');
            }else{
                if(this.mirandoDerecha)
                    this.sprite.anims.play('fall');
                else
                    this.sprite.anims.play('fallL');
            }
        }
	}

    class movediza{
            
        constructor(sprite){
            this.sprite = sprite;
		}
        subir(){
            this.sprite.setVelocityY(-100);
        }
        bajar(){
            this.sprite.setVelocityY(100);
        }
        quietoX(){
            this.sprite.x=430;
        }
        quietoY(){
            this.sprite.setVelocityY(0);
        }

    }
    function platformrandom()
    {
        P1 = new movediza(platrand);
    }

    function create ()
    {
        //Aqui creamos el cielo, y le desactivamos la gravedad para que no se caiga *referencia a chicken little*
        cielo = this.add.tileSprite(0, 0, 4000, 1200, 'cielopro');

        platforms = this.physics.add.staticGroup();
       
        //platforms.create(400, 568, 'ground').setScale(2).refreshBody();

       //platforms.create(600, 400, 'ground');
        //platforms.create(50, 250, 'ground');
        //platforms.create(750, 220, 'ground');
		
        player = this.physics.add.sprite(100, 450, 'waluigi');
        player.setBounce(0.1);
        player.setCollideWorldBounds(false);


		J1 = new jugador(player);
        
        //Animaciones del personaje principal
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('waluigi', { start: 24, end: 29 }),
            frameRate: 9,
            repeat: -1
        });

        this.anims.create({
            key: 'turn',
            frames: [ { key: 'waluigi', frame: 0 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'turnL',
            frames: [ { key: 'waluigi', frame: 42 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'up',
            frames: [ { key: 'waluigi', frame: 2 } ],
            frameRate: 20
        });
        this.anims.create({
            key: 'upL',
            frames: [ { key: 'waluigi', frame: 40 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'down',
            frames: [ { key: 'waluigi', frame: 1 } ],
            frameRate: 20
        });
        this.anims.create({
            key: 'downL',
            frames: [ { key: 'waluigi', frame: 41 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('waluigi', { start: 4, end: 9 }),
            frameRate: 9,
            repeat: -1
        });

        this.anims.create({
            key: 'run',
            frames: this.anims.generateFrameNumbers('waluigi', { start: 14, end: 19 }),
            frameRate: 9,
            repeat: -1
        });

        this.anims.create({
            key: 'runL',
            frames: this.anims.generateFrameNumbers('waluigi', { start: 34, end: 39 }),
            frameRate: 9,
            repeat: -1
        });

        this.anims.create({
            key: 'jump',
            frames: [ { key: 'waluigi', frame: 30 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'jumpL',
            frames: [ { key: 'waluigi', frame: 72 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'fall',
            frames: [ { key: 'waluigi', frame: 31 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'fallL',
            frames: [ { key: 'waluigi', frame: 71 } ],
            frameRate: 20
        });
        cursors = this.input.keyboard.createCursorKeys();

        this.physics.add.collider(player, platforms);

        //Aca se crea la plataforma movediza
        plat = this.physics.add.sprite(110,500, 'base');
        this.physics.add.collider(platforms, plat);
        this.physics.add.collider(plat, player);
        plat.setCollideWorldBounds(true);
        plat.body.allowGravity=false;
        
        JEFE = new jefe(this, J1);

        P1 =new movediza(plat);
        

    }

    function update ()
    {
        //Para hacer que el cielo avance
        cielo.tilePositionX += 1;
        //Para controlar el personaje
        if(cursors.shift.isDown)
            J1.corriendo = true;
        else
            J1.corriendo = false;
        if (cursors.left.isDown)
        {
			J1.mover("Izquierda");
            if (cursors.right.isDown)
            {
                J1.mover("No");
            }
        }
        else if (cursors.right.isDown)
        {
			J1.mover("Derecha");
            if (cursors.left.isDown)
            {
                J1.mover("No");
            }
        }
        else
        {
            J1.mover("No");
        }

        //Por como funciona phaser, debemos checkear que el jugador siga existiendo antes de checkear si está tocando el piso para prevenir un crash
        if(!J1.muerto){
            if (player.body.touching.down)
            {
                J1.saltando=false;
                if(cursors.up.isDown)
                    J1.mover("Arriba");
                if(cursors.down.isDown)
                    J1.mover("Abajo");
                if(!cursors.up.isDown && !cursors.down.isDown){
                    J1.arriba = false;
                    J1.abajo = false;
                }
                if(cursors.space.isDown)
                    J1.saltar();
            }
            if (!player.body.touching.down){
                J1.caer();
            }
            
            //Para controlar las plataformas:
            if (cursors.up.isDown){
                P1.subir();
            }
            else{
                P1.quietoY();
            }
            if(cursors.down.isDown){
                P1.bajar();
            }
        }else{
            P1.quietoY();
        }
      //  P1.quietoX();
    }

</script>

</body>
</html>
